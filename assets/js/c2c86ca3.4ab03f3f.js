"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[375532],{15680:(e,t,n)=>{n.d(t,{xA:()=>p,yg:()=>g});var i=n(296540);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),d=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=d(e.components);return i.createElement(s.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},y=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=d(n),y=a,g=u["".concat(s,".").concat(y)]||u[y]||m[y]||r;return n?i.createElement(g,l(l({ref:t},p),{},{components:n})):i.createElement(g,l({ref:t},p))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,l=new Array(r);l[0]=y;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[u]="string"==typeof e?e:a,l[1]=o;for(var d=2;d<r;d++)l[d]=n[d];return i.createElement.apply(null,l)}return i.createElement.apply(null,n)}y.displayName="MDXCreateElement"},568115:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>o,toc:()=>d});var i=n(58168),a=(n(296540),n(15680));const r={title:"Querying Async Materialized View",language:"en"},l=void 0,o={unversionedId:"query/view-materialized-view/query-async-materialized-view",id:"version-3.0/query/view-materialized-view/query-async-materialized-view",title:"Querying Async Materialized View",description:"\x3c!--",source:"@site/versioned_docs/version-3.0/query/view-materialized-view/query-async-materialized-view.md",sourceDirName:"query/view-materialized-view",slug:"/query/view-materialized-view/query-async-materialized-view",permalink:"/docs/query/view-materialized-view/query-async-materialized-view",draft:!1,tags:[],version:"3.0",frontMatter:{title:"Querying Async Materialized View",language:"en"},sidebar:"docs",previous:{title:"Asynchronous materialized view",permalink:"/docs/query/view-materialized-view/async-materialized-view"},next:{title:"Doris Join Optimization Principle",permalink:"/docs/query/join-optimization/doris-join-optimization"}},s={},d=[{value:"Overview",id:"overview",level:2},{value:"Direct Query of Materialized View",id:"direct-query-of-materialized-view",level:2},{value:"Transparent Rewriting Capability",id:"transparent-rewriting-capability",level:2},{value:"Join rewriting",id:"join-rewriting",level:3},{value:"Aggregate rewriting",id:"aggregate-rewriting",level:3},{value:"Query partial Transparent Rewriting (Coming soon)",id:"query-partial-transparent-rewriting-coming-soon",level:2},{value:"Union Rewriting",id:"union-rewriting",level:2},{value:"Nested Materialized View Rewrite",id:"nested-materialized-view-rewrite",level:2},{value:"Auxiliary Functions",id:"auxiliary-functions",level:2},{value:"Relevant Environment Variables",id:"relevant-environment-variables",level:2},{value:"Limitations",id:"limitations",level:2},{value:"Frequently Asked Questions",id:"frequently-asked-questions",level:2},{value:"1. Why isn&#39;t the materialized view being used?",id:"1-why-isnt-the-materialized-view-being-used",level:3},{value:"2. How to check if the materialized view status is normal?",id:"2-how-to-check-if-the-materialized-view-status-is-normal",level:3},{value:"2.1 Confirm the Materialized View Construction Status",id:"21-confirm-the-materialized-view-construction-status",level:4},{value:"2.2 Confirm the Availability of Consistent Materialized View Data",id:"22-confirm-the-availability-of-consistent-materialized-view-data",level:4},{value:"3. Error During Materialized View Construction",id:"3-error-during-materialized-view-construction",level:3},{value:"4. Error: Unable to Find a Suitable Base Table for Partitioning",id:"4-error-unable-to-find-a-suitable-base-table-for-partitioning",level:3},{value:"5. The materialized view returns no data upon direct query?",id:"5-the-materialized-view-returns-no-data-upon-direct-query",level:3},{value:"6. What happens when the data in the base tables used by the materialized view changes before the materialized view is refreshed?",id:"6-what-happens-when-the-data-in-the-base-tables-used-by-the-materialized-view-changes-before-the-materialized-view-is-refreshed",level:3},{value:"7. How to confirm if the materialized view is hit, and how to check the reason if it&#39;s not hit?",id:"7-how-to-confirm-if-the-materialized-view-is-hit-and-how-to-check-the-reason-if-its-not-hit",level:3}],p={toc:d},u="wrapper";function m(e){let{components:t,...n}=e;return(0,a.yg)(u,(0,i.A)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.yg)("h2",{id:"overview"},"Overview"),(0,a.yg)("p",null,"Doris's asynchronous materialized views employ an algorithm based on the SPJG (SELECT-PROJECT-JOIN-GROUP-BY) pattern\nstructure information for transparent rewriting."),(0,a.yg)("p",null,"Doris can analyze the structural information of query SQL, automatically search for suitable materialized views,\nand attempt transparent rewriting, utilizing the optimal materialized view to express the query SQL."),(0,a.yg)("p",null,"By utilizing precomputed materialized view results,\nsignificant improvements in query performance and a reduction in computational costs can be achieved."),(0,a.yg)("p",null,"Using the three tables: lineitem, orders, and partsupp from TPC-H, let's describe the capability of directly querying\na materialized view and using the materialized view for transparent query rewriting."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE IF NOT EXISTS lineitem (\n    l_orderkey    integer not null,\n    l_partkey     integer not null,\n    l_suppkey     integer not null,\n    l_linenumber  integer not null,\n    l_quantity    decimalv3(15,2) not null,\n    l_extendedprice  decimalv3(15,2) not null,\n    l_discount    decimalv3(15,2) not null,\n    l_tax         decimalv3(15,2) not null,\n    l_returnflag  char(1) not null,\n    l_linestatus  char(1) not null,\n    l_shipdate    date not null,\n    l_commitdate  date not null,\n    l_receiptdate date not null,\n    l_shipinstruct char(25) not null,\n    l_shipmode     char(10) not null,\n    l_comment      varchar(44) not null\n    )\n    DUPLICATE KEY(l_orderkey, l_partkey, l_suppkey, l_linenumber)\n    PARTITION BY RANGE(l_shipdate)\n(FROM ('2023-10-17') TO ('2023-11-01') INTERVAL 1 DAY)\n    DISTRIBUTED BY HASH(l_orderkey) BUCKETS 3\n    PROPERTIES (\"replication_num\" = \"1\");\n\ninsert into lineitem values\n                         (1, 2, 3, 4, 5.5, 6.5, 7.5, 8.5, 'o', 'k', '2023-10-17', '2023-10-17', '2023-10-17', 'a', 'b', 'yyyyyyyyy'),\n                         (2, 4, 3, 4, 5.5, 6.5, 7.5, 8.5, 'o', 'k', '2023-10-18', '2023-10-18', '2023-10-18', 'a', 'b', 'yyyyyyyyy'),\n                         (3, 2, 4, 4, 5.5, 6.5, 7.5, 8.5, 'o', 'k', '2023-10-19', '2023-10-19', '2023-10-19', 'a', 'b', 'yyyyyyyyy');\n")),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE IF NOT EXISTS orders  (\n    o_orderkey       integer not null,\n    o_custkey        integer not null,\n    o_orderstatus    char(1) not null,\n    o_totalprice     decimalv3(15,2) not null,\n    o_orderdate      date not null,\n    o_orderpriority  char(15) not null,\n    o_clerk          char(15) not null,\n    o_shippriority   integer not null,\n    o_comment        varchar(79) not null\n    )\n    DUPLICATE KEY(o_orderkey, o_custkey)\n    PARTITION BY RANGE(o_orderdate)(\n  FROM ('2023-10-17') TO ('2023-11-01') INTERVAL 1 DAY)\n    DISTRIBUTED BY HASH(o_orderkey) BUCKETS 3\n    PROPERTIES (\"replication_num\" = \"1\");\n\n    insert into orders values\n    (1, 1, 'o', 9.5, '2023-10-17', 'a', 'b', 1, 'yy'),\n    (1, 1, 'o', 10.5, '2023-10-18', 'a', 'b', 1, 'yy'),\n    (2, 1, 'o', 11.5, '2023-10-19', 'a', 'b', 1, 'yy'),\n    (3, 1, 'o', 12.5, '2023-10-19', 'a', 'b', 1, 'yy');\n")),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"    CREATE TABLE IF NOT EXISTS partsupp (\n      ps_partkey     INTEGER NOT NULL,\n      ps_suppkey     INTEGER NOT NULL,\n      ps_availqty    INTEGER NOT NULL,\n      ps_supplycost  DECIMALV3(15,2)  NOT NULL,\n      ps_comment     VARCHAR(199) NOT NULL \n    )\n    DUPLICATE KEY(ps_partkey, ps_suppkey)\n    DISTRIBUTED BY HASH(ps_partkey) BUCKETS 3\n    PROPERTIES (\n      \"replication_num\" = \"1\"\n    );\n\n    insert into partsupp values\n    (2, 3, 9, 10.01, 'supply1'),\n    (4, 3, 10, 11.01, 'supply2'),\n    (2, 3, 10, 11.01, 'supply3');\n")),(0,a.yg)("h2",{id:"direct-query-of-materialized-view"},"Direct Query of Materialized View"),(0,a.yg)("p",null,"A materialized view can be considered as a table and can be queried just like a regular table."),(0,a.yg)("p",null,"The syntax for defining a materialized view, details can be found in\n",(0,a.yg)("a",{parentName:"p",href:"../../sql-manual/sql-reference/Data-Definition-Statements/Create/CREATE-ASYNC-MATERIALIZED-VIEW.md"},"CREATE-ASYNC-MATERIALIZED-VIEW")),(0,a.yg)("p",null,"Materialized view definition:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv1\nBUILD IMMEDIATE REFRESH AUTO ON SCHEDULE EVERY 1 hour\nDISTRIBUTED BY RANDOM BUCKETS 3\nPROPERTIES ('replication_num' = '1')\nAS\nSELECT t1.l_linenumber,\n       o_custkey,\n       o_orderdate\nFROM\n    (SELECT * FROM lineitem WHERE l_linenumber > 1) t1\nLEFT OUTER JOIN orders ON l_orderkey = o_orderkey;\n")),(0,a.yg)("p",null,"Query statement:\nDirect queries can be performed on the materialized view with additional filtering conditions and aggregations."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT l_linenumber,\n       o_custkey\nFROM mv1\nWHERE l_linenumber > 1 and o_orderdate = '2023-12-31';\n")),(0,a.yg)("h2",{id:"transparent-rewriting-capability"},"Transparent Rewriting Capability"),(0,a.yg)("h3",{id:"join-rewriting"},"Join rewriting"),(0,a.yg)("p",null,"Join rewriting refers to when the tables used in the query and the materialization are the same.\nIn this case, the optimizer will attempt transparent rewriting by either joining the input of the materialized\nview with the query or placing the join in the outer layer of the query's WHERE clause."),(0,a.yg)("p",null,"This pattern of rewriting is supported for multi-table joins and supported join types is as following:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},"INNER JOIN"),(0,a.yg)("li",{parentName:"ul"},"LEFT OUTER JOIN"),(0,a.yg)("li",{parentName:"ul"},"RIGHT OUTER JOIN"),(0,a.yg)("li",{parentName:"ul"},"FULL OUTER JOIN"),(0,a.yg)("li",{parentName:"ul"},"LEFT SEMI JOIN"),(0,a.yg)("li",{parentName:"ul"},"RIGHT SEMI JOIN"),(0,a.yg)("li",{parentName:"ul"},"LEFT ANTI JOIN"),(0,a.yg)("li",{parentName:"ul"},"RIGHT ANTI JOIN")),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Case 1:")),(0,a.yg)("p",null,"The following case can undergo transparent rewriting. The condition ",(0,a.yg)("inlineCode",{parentName:"p"},"l_linenumber > 1")," allows for pull-up,\nenabling transparent rewriting by expressing the query using the precomputed results of the materialized view."),(0,a.yg)("p",null,"Materialized view definition:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv2\nBUILD IMMEDIATE REFRESH AUTO ON SCHEDULE EVERY 1 hour\nDISTRIBUTED BY RANDOM BUCKETS 3\nPROPERTIES ('replication_num' = '1')\nAS\nSELECT t1.l_linenumber,\n       o_custkey,\n       o_orderdate\nFROM (SELECT * FROM lineitem WHERE l_linenumber > 1) t1\nLEFT OUTER JOIN orders\nON l_orderkey = o_orderkey;\n")),(0,a.yg)("p",null,"Query statement:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT l_linenumber,\n       o_custkey\nFROM lineitem\nLEFT OUTER JOIN orders\nON l_orderkey = o_orderkey\nWHERE l_linenumber > 1 and o_orderdate = '2023-10-18';\n")),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Case 2:")),(0,a.yg)("p",null,"JOIN Derivation occurs when the join type between the query and the materialized view does not match.\nIn cases where the materialization can provide all the necessary data for the query, transparent rewriting can\nstill be achieved by compensating predicates outside the join through predicate push down."),(0,a.yg)("p",null,"For example:"),(0,a.yg)("p",null,"Materialized view definition:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv3\nBUILD IMMEDIATE REFRESH AUTO ON SCHEDULE EVERY 1 hour\nDISTRIBUTED BY RANDOM BUCKETS 3\nPROPERTIES ('replication_num' = '1')\nAS\nSELECT\n    l_shipdate, l_suppkey, o_orderdate\n    sum(o_totalprice) AS sum_total,\n    max(o_totalprice) AS max_total,\n    min(o_totalprice) AS min_total,\n    count(*) AS count_all,\n    count(distinct CASE WHEN o_shippriority > 1 AND o_orderkey IN (1, 3) THEN o_custkey ELSE null END) AS bitmap_union_basic\nFROM lineitem\nLEFT OUTER JOIN orders ON lineitem.l_orderkey = orders.o_orderkey AND l_shipdate = o_orderdate\nGROUP BY\nl_shipdate,\nl_suppkey,\no_orderdate;\n")),(0,a.yg)("p",null,"Query statement:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    l_shipdate, l_suppkey, o_orderdate,\n    sum(o_totalprice) AS sum_total,\n    max(o_totalprice) AS max_total,\n    min(o_totalprice) AS min_total,\n    count(*) AS count_all,\n    count(distinct CASE WHEN o_shippriority > 1 AND o_orderkey IN (1, 3) THEN o_custkey ELSE null END) AS bitmap_union_basic\nFROM lineitem\nINNER JOIN orders ON lineitem.l_orderkey = orders.o_orderkey AND l_shipdate = o_orderdate\nWHERE o_orderdate = '2023-10-18' AND l_suppkey = 3\nGROUP BY\nl_shipdate,\nl_suppkey,\no_orderdate;\n")),(0,a.yg)("h3",{id:"aggregate-rewriting"},"Aggregate rewriting"),(0,a.yg)("p",null,"In the definitions of both the query and the materialized view, the aggregated dimensions can either be consistent or inconsistent.\nFiltering of results can be achieved by using fields from the dimensions in the WHERE clause."),(0,a.yg)("p",null,"The dimensions used in the materialized view need to encompass those used in the query,\nand the metrics utilized in the query can be expressed using the metrics of the materialized view."),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Case 1")),(0,a.yg)("p",null,"The following case can undergo transparent rewriting. The query and the materialized view use consistent dimensions\nfor aggregation, allowing the use of fields from the dimensions to filter results. The query will attempt to use the\nexpressions after SELECT in the materialized view."),(0,a.yg)("p",null,"Materialized view definition:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv4\nBUILD IMMEDIATE REFRESH AUTO ON SCHEDULE EVERY 1 hour\nDISTRIBUTED BY RANDOM BUCKETS 3\nPROPERTIES ('replication_num' = '1')\nAS\nSELECT\n    o_shippriority, o_comment,\n    count(distinct CASE WHEN o_shippriority > 1 AND o_orderkey IN (1, 3) THEN o_custkey ELSE null END) AS cnt_1,\n    count(distinct CASE WHEN O_SHIPPRIORITY > 2 AND o_orderkey IN (2) THEN o_custkey ELSE null END) AS cnt_2,\n    sum(o_totalprice),\n    max(o_totalprice),\n    min(o_totalprice),\n    count(*)\nFROM orders\nGROUP BY\no_shippriority,\no_comment;\n")),(0,a.yg)("p",null,"Query statement:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT \n    o_shippriority, o_comment,\n    count(distinct CASE WHEN o_shippriority > 1 AND o_orderkey IN (1, 3) THEN o_custkey ELSE null END) AS cnt_1,\n    count(distinct CASE WHEN O_SHIPPRIORITY > 2 AND o_orderkey IN (2) THEN o_custkey ELSE null END) AS cnt_2,\n    sum(o_totalprice),\n    max(o_totalprice),\n    min(o_totalprice),\n    count(*)\nFROM orders\nWHERE o_shippriority in (1, 2)\nGROUP BY\no_shippriority,\no_comment;\n")),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Case 2")),(0,a.yg)("p",null,"The following query can be transparently rewritten: the query and the materialization use aggregated dimensions\nthat are inconsistent, but the dimensions used in the materialized view encompass those used in the query.\nThe query can filter results using fields from the dimensions."),(0,a.yg)("p",null,"The query will attempt to roll up using the functions after SELECT, such as the materialized view's\nbitmap_union will eventually roll up into bitmap_union_count, maintaining consistency with the semantics of\nthe count(distinct) in the query."),(0,a.yg)("p",null,"Materialized view definition:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv5\nBUILD IMMEDIATE REFRESH AUTO ON SCHEDULE EVERY 1 hour\nDISTRIBUTED BY RANDOM BUCKETS 3\nPROPERTIES ('replication_num' = '1')\nAS\nSELECT\n    l_shipdate, o_orderdate, l_partkey, l_suppkey,\n    sum(o_totalprice) AS sum_total,\n    max(o_totalprice) AS max_total,\n    min(o_totalprice) AS min_total,\n    count(*) AS count_all,\n    bitmap_union(to_bitmap(CASE WHEN o_shippriority > 1 AND o_orderkey IN (1, 3) THEN o_custkey ELSE null END)) AS bitmap_union_basic\nFROM lineitem\nLEFT OUTER JOIN orders ON lineitem.l_orderkey = orders.o_orderkey AND l_shipdate = o_orderdate\nGROUP BY\nl_shipdate,\no_orderdate,\nl_partkey,\nl_suppkey;\n")),(0,a.yg)("p",null,"Query statement:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    l_shipdate, l_suppkey,\n    sum(o_totalprice) AS sum_total,\n    max(o_totalprice) AS max_total,\n    min(o_totalprice) AS min_total,\n    count(*) AS count_all,\n    count(distinct CASE WHEN o_shippriority > 1 AND o_orderkey IN (1, 3) THEN o_custkey ELSE null END) AS bitmap_union_basic\nFROM lineitem\nLEFT OUTER JOIN orders ON lineitem.l_orderkey = orders.o_orderkey AND l_shipdate = o_orderdate\nWHERE o_orderdate = '2023-10-18' AND l_partkey = 3\nGROUP BY\nl_shipdate,\nl_suppkey;\n")),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Case 3"),"\nSupports transparent rewriting for multidimensional aggregation. That is, if the materialized view does not contain\nGROUPING SETS, CUBE, ROLLUP, and there are multidimensional aggregations in the query. Additionally, if the fields\nafter the group by in the materialized view include all the fields in the multidimensional aggregation in the query,\nthen transparent rewriting can also be performed."),(0,a.yg)("p",null,"Materialized view definition:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv5_1\nBUILD IMMEDIATE REFRESH AUTO ON SCHEDULE EVERY 1 hour\nDISTRIBUTED BY RANDOM BUCKETS 3\nPROPERTIES ('replication_num' = '1')\nAS\nselect o_orderstatus, o_orderdate, o_orderpriority,\n       sum(o_totalprice) as sum_total,\n       max(o_totalprice) as max_total,\n       min(o_totalprice) as min_total,\n       count(*) as count_all\nfrom orders\ngroup by\no_orderstatus, o_orderdate, o_orderpriority;\n")),(0,a.yg)("p",null,"Query statement:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"select o_orderstatus, o_orderdate, o_orderpriority,\n       sum(o_totalprice),\n       max(o_totalprice),\n       min(o_totalprice),\n       count(*)\nfrom orders\ngroup by\nGROUPING SETS ((o_orderstatus, o_orderdate), (o_orderpriority), (o_orderstatus), ());\n")),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Case 4"),"\nWhen the query contains aggregation and the materialized view does not contain aggregation, if all the columns\nused in the query can be obtained from the materialized view, then the rewrite can also be successful."),(0,a.yg)("p",null,"Materialized view definition:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv5_2\nBUILD IMMEDIATE REFRESH AUTO ON SCHEDULE EVERY 1 hour\nDISTRIBUTED BY RANDOM BUCKETS 3\nPROPERTIES ('replication_num' = '1')\nAS\nselect case when o_shippriority > 1 and o_orderkey IN (4, 5) then o_custkey else o_shippriority end,\n       o_orderstatus,\n       bin(o_orderkey)\nfrom orders;\n")),(0,a.yg)("p",null,"Query statement:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"select\n    count(case when o_shippriority > 1 and o_orderkey IN (4, 5) then o_custkey else o_shippriority end),\n    o_orderstatus,\n    bin(o_orderkey)\nfrom orders\ngroup by\n    o_orderstatus,\n    bin(o_orderkey);\n")),(0,a.yg)("p",null,"Temporary support for the aggregation roll-up functions is as follows:"),(0,a.yg)("table",null,(0,a.yg)("thead",{parentName:"table"},(0,a.yg)("tr",{parentName:"thead"},(0,a.yg)("th",{parentName:"tr",align:null},"Functions in Queries"),(0,a.yg)("th",{parentName:"tr",align:null},"Functions in Materialized Views"),(0,a.yg)("th",{parentName:"tr",align:null},"Aggregation Functions After Rewriting"))),(0,a.yg)("tbody",{parentName:"table"},(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"max"),(0,a.yg)("td",{parentName:"tr",align:null},"max"),(0,a.yg)("td",{parentName:"tr",align:null},"max")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"min"),(0,a.yg)("td",{parentName:"tr",align:null},"min"),(0,a.yg)("td",{parentName:"tr",align:null},"min")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"sum"),(0,a.yg)("td",{parentName:"tr",align:null},"sum"),(0,a.yg)("td",{parentName:"tr",align:null},"sum")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"count"),(0,a.yg)("td",{parentName:"tr",align:null},"count"),(0,a.yg)("td",{parentName:"tr",align:null},"sum")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"count(distinct )"),(0,a.yg)("td",{parentName:"tr",align:null},"bitmap_union"),(0,a.yg)("td",{parentName:"tr",align:null},"bitmap_union_count")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"bitmap_union"),(0,a.yg)("td",{parentName:"tr",align:null},"bitmap_union"),(0,a.yg)("td",{parentName:"tr",align:null},"bitmap_union")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"bitmap_union_count"),(0,a.yg)("td",{parentName:"tr",align:null},"bitmap_union"),(0,a.yg)("td",{parentName:"tr",align:null},"bitmap_union_count")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"hll_union_agg, approx_count_distinct, hll_cardinality"),(0,a.yg)("td",{parentName:"tr",align:null},"hll_union \u6216\u8005 hll_raw_agg"),(0,a.yg)("td",{parentName:"tr",align:null},"hll_union_agg")))),(0,a.yg)("h2",{id:"query-partial-transparent-rewriting-coming-soon"},"Query partial Transparent Rewriting (Coming soon)"),(0,a.yg)("p",null,"When the number of tables in the materialized view is greater than the query, if the materialized view\nsatisfies the conditions for JOIN elimination for tables more than the query, transparent rewriting can also occur.\nFor example:"),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Case 1")),(0,a.yg)("p",null,"Materialized view definition:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"}," CREATE MATERIALIZED VIEW mv6\n BUILD IMMEDIATE REFRESH AUTO ON SCHEDULE EVERY 1 hour\n DISTRIBUTED BY RANDOM BUCKETS 3\n PROPERTIES ('replication_num' = '1')\n AS\n SELECT\n     l_linenumber,\n     o_custkey,\n     ps_availqty\n FROM lineitem\n LEFT OUTER JOIN orders ON L_ORDERKEY = O_ORDERKEY\n LEFT OUTER JOIN partsupp ON l_partkey = ps_partkey\n AND l_suppkey = ps_suppkey;\n")),(0,a.yg)("p",null,"Query statement:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"}," SELECT\n     l_linenumber,\n     o_custkey,\n     ps_availqty\n FROM lineitem\n LEFT OUTER JOIN orders ON L_ORDERKEY = O_ORDERKEY;\n")),(0,a.yg)("h2",{id:"union-rewriting"},"Union Rewriting"),(0,a.yg)("p",null,"When a materialized view is insufficient to provide all the data required by a query, a UNION ALL approach can be used to combine data from both the original table and the materialized view for the final result. Currently, the materialized view needs to be a partitioned materialized view, and UNION ALL can be used to supplement the data by applying the filter conditions on the partition fields.\nFor example:"),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Case 1")),(0,a.yg)("p",null,"Materialized view definition:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv7\nBUILD IMMEDIATE REFRESH AUTO ON MANUAL\npartition by(l_shipdate)\nDISTRIBUTED BY RANDOM BUCKETS 2\nPROPERTIES ('replication_num' = '1') \nas\nselect l_shipdate, o_orderdate, l_partkey,\n       l_suppkey, sum(o_totalprice) as sum_total\nfrom lineitem\n       left join orders on lineitem.l_orderkey = orders.o_orderkey and l_shipdate = o_orderdate\ngroup by\n  l_shipdate,\n  o_orderdate,\n  l_partkey,\n  l_suppkey;\n")),(0,a.yg)("p",null,"When a new partition 2023-10-21 is added to the base table and the materialized view has not yet been refreshed, the result can be returned by combining the materialized view with the original table using UNION ALL."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"insert into lineitem values\n    (1, 2, 3, 4, 5.5, 6.5, 7.5, 8.5, 'o', 'k', '2023-10-21', '2023-10-21', '2023-10-21', 'a', 'b', 'yyyyyyyyy');\n")),(0,a.yg)("p",null,"Query statement:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"select l_shipdate, o_orderdate, l_partkey, l_suppkey, sum(o_totalprice) as sum_total\nfrom lineitem\n       left join orders on lineitem.l_orderkey = orders.o_orderkey and l_shipdate = o_orderdate\ngroup by\n  l_shipdate,\n  o_orderdate,\n  l_partkey,\n  l_suppkey;\n")),(0,a.yg)("p",null,"Rewriting result:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"SELECT *\nFROM mv7\nunion all\nselect t1.l_shipdate, o_orderdate, t1.l_partkey, t1.l_suppkey, sum(o_totalprice) as sum_total\nfrom (select * from lineitem where l_shipdate = '2023-10-21') t1\n       left join orders on t1.l_orderkey = orders.o_orderkey and t1.l_shipdate = o_orderdate\ngroup by\n  t1.l_shipdate,\n  o_orderdate,\n  t1.l_partkey,\n  t1.l_suppkey;\n")),(0,a.yg)("p",null,"Noted:\nThe materialized view includes a WHERE condition. For example, if the materialized view is constructed with the filter condition WHERE l_shipdate > '2023-10-19' and the query condition is WHERE l_shipdate > '2023-10-18', this situation currently cannot be compensated for using UNION ALL. This will be supported in the future."),(0,a.yg)("h2",{id:"nested-materialized-view-rewrite"},"Nested Materialized View Rewrite"),(0,a.yg)("p",null,"The definition SQL of a materialized view can use another materialized view; this type of materialized view is called a nested materialized view. Theoretically, there is no limit to the number of nested layers. This materialized view can be queried directly or can participate in transparent rewrite operations. Nested materialized views can also be involved in transparent rewrites."),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Case 1")," "),(0,a.yg)("p",null,"Here is an example to illustrate how nested materialized views work:"),(0,a.yg)("p",null,"First, create the inner materialized view ",(0,a.yg)("inlineCode",{parentName:"p"},"mv8_0_inner_mv"),"."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv8_0_inner_mv\nBUILD IMMEDIATE REFRESH COMPLETE ON MANUAL\nDISTRIBUTED BY RANDOM BUCKETS 2\nPROPERTIES ('replication_num' = '1')\nAS\nselect\nl_linenumber,\no_custkey,\no_orderkey,\no_orderstatus,\nl_partkey,\nl_suppkey,\nl_orderkey\nfrom lineitem\ninner join orders on lineitem.l_orderkey = orders.o_orderkey;\n")),(0,a.yg)("p",null,"Create the outer materialized view ",(0,a.yg)("inlineCode",{parentName:"p"},"mv8_0"),"."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv8_0\nBUILD IMMEDIATE REFRESH COMPLETE ON MANUAL\nDISTRIBUTED BY RANDOM BUCKETS 2\nPROPERTIES ('replication_num' = '1') \nAS\nselect\nl_linenumber,\no_custkey,\no_orderkey,\no_orderstatus,\nl_partkey,\nl_suppkey,\nl_orderkey,\nps_availqty\nfrom mv8_0_inner_mv\ninner join partsupp on l_partkey = ps_partkey AND l_suppkey = ps_suppkey;\n")),(0,a.yg)("p",null,"The following query will result in successful rewrite for both mv8_0_inner_mv and mv8_0. Ultimately, the cost-based optimizer will select mv8_0."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"select lineitem.l_linenumber\nfrom lineitem\ninner join orders on l_orderkey = o_orderkey\ninner join partsupp on  l_partkey = ps_partkey AND l_suppkey = ps_suppkey\nwhere o_orderstatus = 'o'\n")),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Note:")),(0,a.yg)("ol",null,(0,a.yg)("li",{parentName:"ol"},"The more layers of nested materialized views, the longer the time it will take for transparent rewriting. It is recommended not to exceed 3 layers of nested materialized views."),(0,a.yg)("li",{parentName:"ol"},"Transparent rewriting of nested materialized views is disabled by default. See the switch below for enabling it.")),(0,a.yg)("h2",{id:"auxiliary-functions"},"Auxiliary Functions"),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Data Consistency Issues After Transparent Rewriting")),(0,a.yg)("p",null,"The unit of ",(0,a.yg)("inlineCode",{parentName:"p"},"grace_period")," is seconds, referring to the permissible time for inconsistency between the materialized\nview and the data in the underlying base tables."),(0,a.yg)("p",null,"For example, setting ",(0,a.yg)("inlineCode",{parentName:"p"},"grace_period")," to 0 means requiring the materialized view to be consistent with the base\ntable data before it can be used for transparent rewriting. As for external tables,\nsince changes in data cannot be perceived, the materialized view is used with them.\nRegardless of whether the data in the external table is up-to-date or not, this materialized view can be used for\ntransparent rewriting. If the external table is configured with an HMS metadata source,\nit becomes capable of perceiving data changes. Configuring the metadata source and enabling data change\nperception functionality will be supported in subsequent iterations."),(0,a.yg)("p",null,"Setting ",(0,a.yg)("inlineCode",{parentName:"p"},"grace_period")," to 10 means allowing a 10-second delay between the data in the materialized view and\nthe data in the base tables. If there is a delay of up to 10 seconds between the data in the materialized\nview and the data in the base tables, the materialized view can still be used for transparent rewriting within\nthat time frame."),(0,a.yg)("p",null,"For internal tables in the materialized view, you can control the maximum delay allowed for the data used by\nthe transparent rewriting by setting the ",(0,a.yg)("inlineCode",{parentName:"p"},"grace_period")," property.\nRefer to ",(0,a.yg)("a",{parentName:"p",href:"/docs/sql-manual/sql-statements/Data-Definition-Statements/Create/CREATE-ASYNC-MATERIALIZED-VIEW"},"CREATE-ASYNC-MATERIALIZED-VIEW")),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"Viewing and Debugging Transparent Rewrite Hit Information")),(0,a.yg)("p",null,"You can use the following statements to view the hit information of transparent rewriting for a materialized view.\nIt will display a concise overview of the transparent rewriting process."),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"explain <query_sql>")," The information returned is as follows, with the relevant information pertaining to materialized views extracted:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-text"},"| MaterializedView                                                                                                                                                                                                                                      |\n| MaterializedViewRewriteSuccessAndChose:                                                                                                                                                                                                               |\n|   Names: mv5                                                                                                                                                                                                                                          |\n| MaterializedViewRewriteSuccessButNotChose:                                                                                                                                                                                                            |\n|                                                                                                                                                                                                                                                       |\n| MaterializedViewRewriteFail:                                                                                                                                                                                                                          |\n|   Name: mv4                                                                                                                                                                                                                                           |\n|   FailSummary: Match mode is invalid, View struct info is invalid                                                                                                                                                                                     |\n|   Name: mv3                                                                                                                                                                                                                                           |\n|   FailSummary: Match mode is invalid, Rewrite compensate predicate by view fail, View struct info is invalid                                                                                                                                          |\n|   Name: mv1                                                                                                                                                                                                                                           |\n|   FailSummary: The columns used by query are not in view, View struct info is invalid                                                                                                                                                                 |\n|   Name: mv2                                                                                                                                                                                                                                           |\n|   FailSummary: The columns used by query are not in view, View struct info is invalid\n")),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"MaterializedViewRewriteSuccessAndChose"),": Transparent rewrite succeeded, and the materialized view names list\nchosen by the CBO."),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"MaterializedViewRewriteSuccessButNotChose"),": Transparent rewrite succeeded, but the final CBO did not choose the\nmaterialized view names list."),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"MaterializedViewRewriteFail"),": Lists transparent rewrite failures and summarizes the reasons."),(0,a.yg)("p",null,"If you want to know the detailed information about materialized view candidates, rewriting, and the final selection process,\nyou can execute the following statement. It will provide a detailed breakdown of the transparent rewriting process."),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"explain memo plan <query_sql>")),(0,a.yg)("h2",{id:"relevant-environment-variables"},"Relevant Environment Variables"),(0,a.yg)("table",null,(0,a.yg)("thead",{parentName:"table"},(0,a.yg)("tr",{parentName:"thead"},(0,a.yg)("th",{parentName:"tr",align:null},"Switch"),(0,a.yg)("th",{parentName:"tr",align:null},"Description"))),(0,a.yg)("tbody",{parentName:"table"},(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"SET enable_nereids_planner = true;"),(0,a.yg)("td",{parentName:"tr",align:null},"Asynchronous materialized views are only supported under the new optimizer, so the new optimizer needs to be enabled.")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"SET enable_materialized_view_rewrite = true;"),(0,a.yg)("td",{parentName:"tr",align:null},"Enable or disable query transparent rewriting, default is enabled")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"SET materialized_view_rewrite_enable_contain_external_table = true;"),(0,a.yg)("td",{parentName:"tr",align:null},"Whether materialized views participating in transparent rewriting are allowed to contain external tables, default is not allowed")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"SET materialized_view_rewrite_success_candidate_num = 3;"),(0,a.yg)("td",{parentName:"tr",align:null},"Transparently rewrites the successful result set, allowing the maximum number of CBO candidates to participate, the default is 3")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"SET enable_materialized_view_union_rewrite = true;"),(0,a.yg)("td",{parentName:"tr",align:null},"Whether to allow the union of base table and materialized view using UNION ALL when the partitioned materialized view is insufficient to provide all the data required by a query. Default is enabled.")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"SET enable_materialized_view_nest_rewrite = true;"),(0,a.yg)("td",{parentName:"tr",align:null},"Whether to allow nested rewriting. Default is disabled.")),(0,a.yg)("tr",{parentName:"tbody"},(0,a.yg)("td",{parentName:"tr",align:null},"SET materialized_view_relation_mapping_max_count = 8;"),(0,a.yg)("td",{parentName:"tr",align:null},"Maximum number of relation mappings allowed during transparent rewrite. If exceeded, truncation will occur. Relation mapping is typically generated by self-joins in tables and the number is usually the Cartesian product, for example, if there are 3 tables, it may generate 8 combinations. Default is 8.")))),(0,a.yg)("h2",{id:"limitations"},"Limitations"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"Materialized view definition statements are only allowed to include SELECT, FROM, WHERE, JOIN, and GROUP BY clauses. ")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"The input to JOIN can include simple GROUP BY (single-table aggregation). Supported JOIN types include INNER, LEFT OUTER JOIN, ")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"RIGHT OUTER JOIN, FULL OUTER JOIN, LEFT SEMI JOIN, RIGHT SEMI JOIN, LEFT ANTI JOIN, and RIGHT ANTI JOIN.")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"Materialized views based on External Tables do not guarantee strong consistency of query results.")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"The use of non-deterministic functions to construct materialized views is not supported, including rand, now, current_time, ")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"current_date, random, uuid, etc.")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"Transparent rewriting does not support window functions.")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"Materialized views with LIMIT are currently not supported for transparent rewriting.")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"Currently, materialized view definitions cannot utilize views or other materialized views.")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"When the query or materialized view has no data, transparent rewriting is not supported.")),(0,a.yg)("li",{parentName:"ul"},(0,a.yg)("p",{parentName:"li"},"Currently, WHERE condition compensation only supports compensating conditions on numeric and date type columns.\nFor example, if the materialized view is defined as a > 5 and the query is a > 10, transparent rewriting is supported."))),(0,a.yg)("h2",{id:"frequently-asked-questions"},"Frequently Asked Questions"),(0,a.yg)("h3",{id:"1-why-isnt-the-materialized-view-being-used"},"1. Why isn't the materialized view being used?"),(0,a.yg)("p",null,"To determine why a materialized view is not being used, execute the following SQL:"),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"explain your_query_sql;")),(0,a.yg)("p",null,"a. The transparent rewriting feature for materialized views is disabled by default. You need to enable the corresponding switch for it to work. See the related switches for asynchronous materialized views."),(0,a.yg)("p",null,"b. The materialized view may not be available, causing transparent rewriting to fail. Check the status of materialized view construction, see problem 2."),(0,a.yg)("p",null,"c. After checking the first two steps, if the materialized view is still not being used, it may be because the definition SQL of the materialized view and the query SQL are not within the current capability of the materialized view rewriting. See the capabilities of materialized view transparent rewriting."),(0,a.yg)("h3",{id:"2-how-to-check-if-the-materialized-view-status-is-normal"},"2. How to check if the materialized view status is normal?"),(0,a.yg)("h4",{id:"21-confirm-the-materialized-view-construction-status"},"2.1 Confirm the Materialized View Construction Status"),(0,a.yg)("p",null,"To participate in transparent rewriting, the status of the materialized view must be Success. First, run the following SQL to check the JobName of the materialized view:"),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"select * from mv_infos('database'='db_name') where Name = 'mv_name'")),(0,a.yg)("p",null,"Next, use the JobName to check the task status of the materialized view. Run the following SQL:"),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},'select * from tasks("type"="mv") where JobName = \'job_name\';')),(0,a.yg)("p",null,"Check if the status of the most recent task execution is Success."),(0,a.yg)("h4",{id:"22-confirm-the-availability-of-consistent-materialized-view-data"},"2.2 Confirm the Availability of Consistent Materialized View Data"),(0,a.yg)("p",null,"If the materialized view is successfully built but is unavailable due to data changes and the ",(0,a.yg)("inlineCode",{parentName:"p"},"grace_period")," setting,\nconfirm the availability of consistent materialized view data."),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"For Full Refresh Materialized Views:")),(0,a.yg)("p",null,"Run the following SQL and check if the ",(0,a.yg)("inlineCode",{parentName:"p"},"SyncWithBaseTables")," field is 1:"),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"select * from mv_infos('database'='db_name') where Name = 'mv_name'")),(0,a.yg)("p",null,(0,a.yg)("strong",{parentName:"p"},"For Partitioned Materialized Views:")," "),(0,a.yg)("p",null,"Run the following SQL to check if the partitions used in the query are valid:\n",(0,a.yg)("inlineCode",{parentName:"p"},"show partitions from mv_name;")),(0,a.yg)("h3",{id:"3-error-during-materialized-view-construction"},"3. Error During Materialized View Construction"),(0,a.yg)("p",null,"Error Message:"),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"ERROR 1105 (HY000): errCode = 2, detailMessage = Syntax error in line 1:\nBUILD IMMEDIATE REFRESH AUTO ON MANUAL")),(0,a.yg)("p",null,"a. The statement for asynchronous materialized views is only supported under the new optimizer.\nEnsure that the new optimizer is enabled:"),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"SET global enable_nereids_planner = true;")),(0,a.yg)("p",null,"b. It's possible that there is a typo in the keywords used in the statement to build the materialized view, or there\nmay be syntax errors in the materialized view definition SQL. Check the materialized view definition SQL and the create\nmaterialized view statement to ensure correctness."),(0,a.yg)("h3",{id:"4-error-unable-to-find-a-suitable-base-table-for-partitioning"},"4. Error: Unable to Find a Suitable Base Table for Partitioning"),(0,a.yg)("p",null,"This error typically indicates that the SQL definition of the materialized view and the selection of partitioning fields\nfor the materialized view are not suitable for partitioned incremental updates. Therefore, creating a partitioned\nmaterialized view will result in this error."),(0,a.yg)("p",null,"For a materialized view to support partitioned incremental updates, it needs to meet certain requirements.\nFor more details, refer to the ",(0,a.yg)("a",{parentName:"p",href:"/docs/sql-manual/sql-statements/Data-Definition-Statements/Create/CREATE-ASYNC-MATERIALIZED-VIEW"},"CREATE ASYNC MATERIALIZED VIEW documentation"),"."),(0,a.yg)("p",null,"Here is an example to illustrate the construction of a partitioned materialized view:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},'   CREATE TABLE IF NOT EXISTS lineitem (\n   l_orderkey    INTEGER NOT NULL,\n   l_partkey     INTEGER NOT NULL,\n   l_suppkey     INTEGER NOT NULL,\n   l_linenumber  INTEGER NOT NULL,\n   l_quantity    DECIMALV3(15,2) NOT NULL,\n   l_extendedprice  DECIMALV3(15,2) NOT NULL,\n   l_discount    DECIMALV3(15,2) NOT NULL,\n   l_tax         DECIMALV3(15,2) NOT NULL,\n   l_returnflag  CHAR(1) NOT NULL,\n   l_linestatus  CHAR(1) NOT NULL,\n   l_shipdate    DATE NOT NULL,\n   l_commitdate  DATE NOT NULL,\n   l_receiptdate DATE NOT NULL,\n   l_shipinstruct CHAR(25) NOT NULL,\n   l_shipmode     CHAR(10) NOT NULL,\n   l_comment      VARCHAR(44) NOT NULL\n   )\n   DUPLICATE KEY(l_orderkey, l_partkey, l_suppkey, l_linenumber)\n   PARTITION BY RANGE(l_shipdate) (\n   PARTITION `day_1` VALUES LESS THAN (\'2023-12-9\'),\n   PARTITION `day_2` VALUES LESS THAN ("2023-12-11"),\n   PARTITION `day_3` VALUES LESS THAN ("2023-12-30"))\n   DISTRIBUTED BY HASH(l_orderkey) BUCKETS 3\n   PROPERTIES (\n   "replication_num" = "1"\n              );\n')),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},'    CREATE TABLE IF NOT EXISTS orders  (\n   o_orderkey       INTEGER NOT NULL,\n   o_custkey        INTEGER NOT NULL,\n   o_orderstatus    CHAR(1) NOT NULL,\n   o_totalprice     DECIMALV3(15,2) NOT NULL,\n   o_orderdate      DATE NOT NULL,\n   o_orderpriority  CHAR(15) NOT NULL,\n   o_clerk          CHAR(15) NOT NULL,\n   o_shippriority   INTEGER NOT NULL,\n   O_COMMENT        VARCHAR(79) NOT NULL\n   )\n   DUPLICATE KEY(o_orderkey, o_custkey)\n   PARTITION BY RANGE(o_orderdate) (\n   PARTITION `day_2` VALUES LESS THAN (\'2023-12-9\'),\n   PARTITION `day_3` VALUES LESS THAN ("2023-12-11"),\n   PARTITION `day_4` VALUES LESS THAN ("2023-12-30")\n   )\n   DISTRIBUTED BY HASH(o_orderkey) BUCKETS 3\n   PROPERTIES (\n   "replication_num" = "1"\n              );\n')),(0,a.yg)("p",null,"If l_shipdate is the partition field of the base table lineitem, the following materialized view can be incrementally\nupdated by partition."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv9\nBUILD IMMEDIATE REFRESH AUTO ON MANUAL\npartition by(l_shipdate)\nDISTRIBUTED BY HASH(l_orderkey) BUCKETS 10\nPROPERTIES ('replication_num' = '1') \nAS\nSELECT l_shipdate, l_orderkey, O_ORDERDATE,\n       count(O_ORDERDATE) over (partition by l_shipdate order by l_orderkey) as window_count\nFROM lineitem\nLEFT OUTER JOIN orders on l_orderkey = o_orderkey\nGROUP BY l_shipdate, l_orderkey, O_ORDERDATE;\n")),(0,a.yg)("p",null,"The following materialized view cannot be incrementally updated by partition because l_shipdate is generated from the\nright side of a LEFT OUTER JOIN and may produce null values."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv10\nBUILD IMMEDIATE REFRESH AUTO ON MANUAL\npartition by(l_shipdate)\nDISTRIBUTED BY HASH(l_orderkey) BUCKETS 10\nPROPERTIES ('replication_num' = '1') \nAS\nSELECT l_shipdate, l_orderkey, O_ORDERDATE,\n       count(O_ORDERDATE) over (partition by l_shipdate order by l_orderkey) as window_count\nFROM orders \nLEFT OUTER JOIN lineitem on l_orderkey = o_orderkey\nGROUP BY l_shipdate, l_orderkey, O_ORDERDATE;\n")),(0,a.yg)("h3",{id:"5-the-materialized-view-returns-no-data-upon-direct-query"},"5. The materialized view returns no data upon direct query?"),(0,a.yg)("p",null,"   The materialized view might still be under construction or the construction process might have failed. Use the following\nstatement to check the status of materialized view construction:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"   -- \u67e5\u770b\u7269\u5316\u89c6\u56fe\u5143\u6570\u636e\u4fe1\u606f,database \u4e3a\u5f53\u524d\u6570\u636e\u5e93, mv_name \u4e3a\u7269\u5316\u89c6\u56fe\u540d\u79f0\n   select * from mv_infos('database'='db_name') where Name = 'mv_name' \\G\n")),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},'-- \u67e5\u770b\u4efb\u52a1\u5143\u6570\u636e\nselect * from jobs("type"="mv") order by CreateTime limit 5;\n')),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},'-- \u67e5\u770b\u4efb\u52a1\u6267\u884c\u4fe1\u606f\uff0c\u8fd9\u91cc\u9762\u4f1a\u5c55\u793a\u4efb\u52a1\u6267\u884c\u7684\u72b6\u6001\uff0c\u5982\u679c\u5931\u8d25\u4f1a\u6709\u5931\u8d25\u539f\u56e0\nselect * from tasks("type"="mv") where JobName = \'job_name\';\n')),(0,a.yg)("h3",{id:"6-what-happens-when-the-data-in-the-base-tables-used-by-the-materialized-view-changes-before-the-materialized-view-is-refreshed"},"6. What happens when the data in the base tables used by the materialized view changes before the materialized view is refreshed?"),(0,a.yg)("p",null,"The timeliness of data in asynchronous materialized views has a certain delay compared to the base tables."),(0,a.yg)("p",null,"For internal tables and external tables that can perceive data changes (such as Hive tables),\nwhether a materialized view can be used for transparent rewriting when the data in the base tables changes\nbefore the materialized view is refreshed depends on the threshold set by ",(0,a.yg)("inlineCode",{parentName:"p"},"grace_period"),"."),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"grace_period")," refers to the time allowance for the materialized view to be inconsistent with the data from the base tables."),(0,a.yg)("p",null,"For example, if ",(0,a.yg)("inlineCode",{parentName:"p"},"grace_period")," is set to 0, it means that the materialized view must be consistent with the data in the base\ntables before it can be used for transparent rewriting. "),(0,a.yg)("p",null,"For external tables (except Hive tables), since data changes cannot be perceived, the materialized view can be used for transparent rewriting regardless of whether the data in the external tables is up-to-date (in this case, data inconsistency may occur)."),(0,a.yg)("p",null,"If ",(0,a.yg)("inlineCode",{parentName:"p"},"grace_period")," is set to 10, it means that the materialized view and the base table data are allowed to have a delay of 10 seconds. If there is a delay in the data of the materialized view compared to the base tables within 10 seconds, the materialized view can still be used for transparent rewriting."),(0,a.yg)("p",null,"For partitioned materialized views, if some partitions become invalid, there are two scenarios:"),(0,a.yg)("p",null,"a. If the query does not use data from the invalid partitions, the materialized view can still be used for transparent rewriting."),(0,a.yg)("p",null,"b. If the query uses data from the invalid partitions and the data is within the grace_period, the materialized view can still be used. If the data in the materialized view is not within the grace_period, the query can be responded to by using UNION ALL with the original table and the materialized view."),(0,a.yg)("h3",{id:"7-how-to-confirm-if-the-materialized-view-is-hit-and-how-to-check-the-reason-if-its-not-hit"},"7. How to confirm if the materialized view is hit, and how to check the reason if it's not hit?"),(0,a.yg)("p",null,"You can use the ",(0,a.yg)("inlineCode",{parentName:"p"},"explain query_sql")," command to see a summary of whether the materialized view is hit or not. For example,\nconsider the following materialized view:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"CREATE MATERIALIZED VIEW mv11\nBUILD IMMEDIATE REFRESH AUTO ON MANUAL\npartition by(l_shipdate)\nDISTRIBUTED BY HASH(l_orderkey) BUCKETS 10\nPROPERTIES ('replication_num' = '1')\nAS\nSELECT l_shipdate, l_orderkey, O_ORDERDATE, count(*)\nFROM lineitem  \nLEFT OUTER JOIN orders on l_orderkey = o_orderkey\nGROUP BY l_shipdate, l_orderkey, O_ORDERDATE;\n")),(0,a.yg)("p",null,"Now, let's analyze the following query:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"explain\nSELECT l_shipdate, l_linestatus, O_ORDERDATE, count(*)\nFROM orders\nLEFT OUTER JOIN lineitem on l_orderkey = o_orderkey\nGROUP BY l_shipdate, l_linestatus, O_ORDERDATE;\n")),(0,a.yg)("p",null,"The explain command will show information about whether the materialized view is hit or not.\nIf it's not hit, it will provide a summary of the failure reason. For example:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-text"},"| MaterializedView                                                                                                          |\n| MaterializedViewRewriteSuccessAndChose:                                                                                   |\n|                                                                                                                           |\n| MaterializedViewRewriteSuccessButNotChose:                                                                                |\n|                                                                                                                           |\n| MaterializedViewRewriteFail:                                                                                              |\n|   Name: internal#doc_test#mv11                                                                                            |\n|   FailSummary: View struct info is invalid, The graph logic between query and view is not consistent\n")),(0,a.yg)("p",null,"In this case, the failure reason is ",(0,a.yg)("inlineCode",{parentName:"p"},"The graph logic between query and view is not consistent"),",\nwhich means that the join order in the query is not consistent with the join order in the materialized view."),(0,a.yg)("p",null,"Let's consider another query:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-sql"},"explain\nSELECT l_shipdate, l_linestatus, O_ORDERDATE, count(*)\nFROM lineitem  \nLEFT OUTER JOIN orders on l_orderkey = o_orderkey\nGROUP BY l_shipdate, l_linestatus, O_ORDERDATE;\n")),(0,a.yg)("p",null,"If this query also fails to hit the materialized view, the summary might be:"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-text"},"| MaterializedView                                                                                                          |\n| MaterializedViewRewriteSuccessAndChose:                                                                                   |\n|                                                                                                                           |\n| MaterializedViewRewriteSuccessButNotChose:                                                                                |\n|                                                                                                                           |\n| MaterializedViewRewriteFail:                                                                                              |\n|   Name: internal#doc_test#mv11                                                                                            |\n|   FailSummary: View struct info is invalid, View dimensions doesn't not cover the query dimensions    \n")),(0,a.yg)("p",null,"In this case, the failure reason is ",(0,a.yg)("inlineCode",{parentName:"p"},"View dimensions doesn't not cover the query dimensions"),", indicating that\nthe fields used in the ",(0,a.yg)("inlineCode",{parentName:"p"},"GROUP BY")," clause of the query cannot be obtained from the ",(0,a.yg)("inlineCode",{parentName:"p"},"GROUP BY")," clause\nof the materialized view."))}m.isMDXComponent=!0}}]);